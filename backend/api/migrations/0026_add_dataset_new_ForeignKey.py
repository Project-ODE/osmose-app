# Generated by Django 3.2.23 on 2023-11-22 14:43

from django.db import migrations
from django.db import connection
from copy import deepcopy
from collections import defaultdict
from backend.api.models import SpectroConfig

def add_dataset_new_ForeignKey(apps, schema_editor):
    with connection.cursor() as cursor:
        cursor.execute("SElECT spectroconfig_id, dataset_id FROM datasets_spectro_configs")
        spectro_datasets = defaultdict(list)
        for spectroconfig_id, dataset_id in cursor.fetchall():
            spectro_datasets[spectroconfig_id].append(dataset_id)

        for spectro, datasets in spectro_datasets.items():
            spectro_config = SpectroConfig.objects.get(id=spectro)
            spectro_config.dataset_id = datasets[0]
            spectro_config.save()

            if len(datasets) > 1:
                for dataset in datasets[1:]:
                    new_spectro_config = deepcopy(spectro_config)
                    new_spectro_config.pk = None
                    new_spectro_config.dataset_id = dataset
                    new_spectro_config.save()

class Migration(migrations.Migration):

    dependencies = [
        ('api', '0025_add_spectroconfig'),
    ]

    operations = [
        
        migrations.RunPython(add_dataset_new_ForeignKey),
    ]
